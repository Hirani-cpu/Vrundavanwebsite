<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .test-result {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="test-card">
        <h1>üî• Firebase & Firestore Connection Test</h1>
        <p>This page will help diagnose why bookings aren't showing in the dashboard.</p>

        <div id="testResults"></div>

        <div style="margin-top: 20px;">
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testRoomBookings()">Test Room Bookings</button>
            <button onclick="testEventBookings()">Test Event Bookings</button>
            <button onclick="createTestBooking()">Create Test Room Booking</button>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const resultsDiv = document.getElementById('testResults');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        // Test 1: Check if Firebase is initialized
        function testFirebaseInit() {
            addResult('<strong>Test 1: Firebase Initialization</strong>', 'info');

            if (typeof firebase !== 'undefined') {
                addResult('‚úì Firebase SDK loaded successfully', 'success');

                if (typeof db !== 'undefined') {
                    addResult('‚úì Firestore database initialized', 'success');
                    return true;
                } else {
                    addResult('‚úó Firestore database NOT initialized', 'error');
                    return false;
                }
            } else {
                addResult('‚úó Firebase SDK not loaded', 'error');
                return false;
            }
        }

        // Test 2: Try to read room bookings
        function testRoomBookings() {
            clearResults();
            addResult('<strong>Test 2: Reading Room Bookings</strong>', 'info');
            addResult('<span class="loading">Fetching room bookings from Firestore...</span>', 'info');

            db.collection('roomBookings')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    addResult(`‚úì Query successful! Found ${querySnapshot.size} room booking(s)`, 'success');

                    if (querySnapshot.empty) {
                        addResult('‚ÑπÔ∏è No room bookings found. The collection might be empty.', 'info');
                        addResult('Try creating a test booking using the button below.', 'info');
                    } else {
                        let html = '<strong>Room Bookings Data:</strong><pre>';
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            html += `\nBooking ID: ${doc.id}\n`;
                            html += JSON.stringify(data, null, 2) + '\n---\n';
                        });
                        html += '</pre>';
                        addResult(html, 'success');
                    }
                })
                .catch((error) => {
                    addResult(`‚úó Error fetching room bookings: ${error.message}`, 'error');
                    addResult(`<pre>Error Code: ${error.code}\nError Details: ${error.message}</pre>`, 'error');

                    if (error.code === 'permission-denied') {
                        addResult('‚ö†Ô∏è Permission denied! This means Firestore security rules are blocking the query. You need to update your Firestore rules.', 'error');
                    }
                });
        }

        // Test 3: Try to read event bookings
        function testEventBookings() {
            clearResults();
            addResult('<strong>Test 3: Reading Event Bookings</strong>', 'info');
            addResult('<span class="loading">Fetching event bookings from Firestore...</span>', 'info');

            db.collection('eventBookings')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    addResult(`‚úì Query successful! Found ${querySnapshot.size} event booking(s)`, 'success');

                    if (querySnapshot.empty) {
                        addResult('‚ÑπÔ∏è No event bookings found. The collection might be empty.', 'info');
                    } else {
                        let html = '<strong>Event Bookings Data:</strong><pre>';
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            html += `\nBooking ID: ${doc.id}\n`;
                            html += JSON.stringify(data, null, 2) + '\n---\n';
                        });
                        html += '</pre>';
                        addResult(html, 'success');
                    }
                })
                .catch((error) => {
                    addResult(`‚úó Error fetching event bookings: ${error.message}`, 'error');
                    addResult(`<pre>Error Code: ${error.code}\nError Details: ${error.message}</pre>`, 'error');

                    if (error.code === 'permission-denied') {
                        addResult('‚ö†Ô∏è Permission denied! This means Firestore security rules are blocking the query.', 'error');
                    }
                });
        }

        // Test 4: Create a test booking
        function createTestBooking() {
            clearResults();
            addResult('<strong>Test 4: Creating Test Room Booking</strong>', 'info');
            addResult('<span class="loading">Creating test booking...</span>', 'info');

            const testBooking = {
                fullName: 'Test User',
                phone: '9876543210',
                email: 'test@example.com',
                checkIn: '2025-01-15',
                checkOut: '2025-01-17',
                adults: 2,
                children: 0,
                roomType: 'Deluxe AC Room',
                specialRequests: 'Test booking created by diagnostic tool',
                bookingStatus: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('roomBookings')
                .add(testBooking)
                .then((docRef) => {
                    addResult(`‚úì Test booking created successfully!`, 'success');
                    addResult(`Document ID: ${docRef.id}`, 'success');
                    addResult('Now try running "Test Room Bookings" to see if it appears.', 'info');
                })
                .catch((error) => {
                    addResult(`‚úó Error creating test booking: ${error.message}`, 'error');
                    addResult(`<pre>Error Code: ${error.code}\nError Details: ${error.message}</pre>`, 'error');

                    if (error.code === 'permission-denied') {
                        addResult('‚ö†Ô∏è Permission denied! Firestore security rules are blocking writes. Check your Firestore rules in Firebase Console.', 'error');
                    }
                });
        }

        // Run all tests
        function runAllTests() {
            clearResults();
            addResult('<h2>Running All Diagnostic Tests...</h2>', 'info');

            if (testFirebaseInit()) {
                addResult('<br>', 'info');
                testRoomBookings();

                setTimeout(() => {
                    addResult('<br>', 'info');
                    testEventBookings();
                }, 2000);
            }
        }

        // Auto-run basic test on load
        window.addEventListener('load', function() {
            testFirebaseInit();
        });
    </script>
</body>
</html>
